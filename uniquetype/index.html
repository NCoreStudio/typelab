<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã‚ã‚‰ã„ã®ãƒ„ãƒœè¨ºæ–­</title>
<link href="https://fonts.googleapis.com/css2?family=Zen+Marugothic&family=DotGothic16&family=Kaisei+Decol:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --c-bg: #fff8f0;
    --c-card: #ffffff;
    --c-hotoko: #ff9eb5;
    --c-hotoko-light: #ffeef4;
    --c-hirameĞºĞ¸: #7ec8e3;
    --c-hirameki: #7ec8e3;
    --c-hirameki-light: #e8f7fc;
    --c-spicy: #ffb347;
    --c-spicy-light: #fff4e0;
    --c-chaos: #b59fdb;
    --c-chaos-light: #f3eeff;
    --c-text: #3d2b1f;
    --c-muted: #9b8b82;
    --c-accent: #ff6b9d;
    --r: 20px;
    --shadow: 0 4px 24px rgba(0,0,0,0.08);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Zen Marugothic', sans-serif;
    background: var(--c-bg);
    min-height: 100vh;
    color: var(--c-text);
    overflow-x: hidden;
  }

  /* â”€â”€â”€ èƒŒæ™¯ãƒ‡ã‚³ â”€â”€â”€ */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(circle at 15% 20%, #ffd6e7 0%, transparent 40%),
      radial-gradient(circle at 85% 75%, #c8e6ff 0%, transparent 40%),
      radial-gradient(circle at 50% 50%, #f3eeff 0%, transparent 60%);
    z-index: 0;
    pointer-events: none;
  }

  .wrapper {
    position: relative;
    z-index: 1;
    max-width: 480px;
    margin: 0 auto;
    padding: 0 16px 60px;
  }

  /* â”€â”€â”€ START SCREEN â”€â”€â”€ */
  #screen-start {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    text-align: center;
    gap: 24px;
    padding: 40px 0;
  }

  .logo-area {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
  }

  .logo-emoji {
    font-size: 64px;
    animation: bounce 2s ease-in-out infinite;
  }

  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-12px); }
  }

  .title-main {
    font-family: 'Kaisei Decol', serif;
    font-weight: 700;
    font-size: 32px;
    color: var(--c-text);
    line-height: 1.2;
    letter-spacing: 0.05em;
  }

  .title-sub {
    font-size: 14px;
    color: var(--c-muted);
    letter-spacing: 0.1em;
  }

  .start-card {
    background: white;
    border-radius: var(--r);
    padding: 28px 24px;
    box-shadow: var(--shadow);
    width: 100%;
  }

  .start-card p {
    font-size: 15px;
    line-height: 2;
    color: var(--c-text);
    text-align: left;
  }

  .type-preview {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-top: 20px;
  }

  .type-chip {
    border-radius: 50px;
    padding: 8px 12px;
    font-size: 13px;
    text-align: center;
    font-weight: bold;
    letter-spacing: 0.03em;
  }
  .chip-a { background: var(--c-hotoko-light); color: #c0396a; }
  .chip-b { background: var(--c-hirameki-light); color: #2a7a96; }
  .chip-c { background: var(--c-spicy-light); color: #b05f00; }
  .chip-d { background: var(--c-chaos-light); color: #6b4ca0; }

  .btn-start {
    background: linear-gradient(135deg, #ff6b9d, #ff9eb5);
    color: white;
    border: none;
    border-radius: 50px;
    padding: 16px 48px;
    font-family: 'Kaisei Decol', serif;
    font-size: 20px;
    font-weight: 700;
    letter-spacing: 0.1em;
    cursor: pointer;
    box-shadow: 0 6px 20px rgba(255,107,157,0.4);
    transition: transform 0.15s, box-shadow 0.15s;
    width: 100%;
  }
  .btn-start:hover { transform: translateY(-2px); box-shadow: 0 10px 28px rgba(255,107,157,0.5); }
  .btn-start:active { transform: translateY(0); }

  .note-text {
    font-size: 12px;
    color: var(--c-muted);
    text-align: center;
  }

  /* â”€â”€â”€ QUESTION SCREEN â”€â”€â”€ */
  #screen-quiz {
    display: none;
    flex-direction: column;
    min-height: 100vh;
    padding-top: 24px;
    gap: 20px;
  }

  .quiz-header {
    text-align: center;
  }

  .quiz-count {
    font-size: 13px;
    color: var(--c-muted);
    letter-spacing: 0.1em;
    margin-bottom: 8px;
  }

  .progress-bar-wrap {
    background: #f0e8e4;
    border-radius: 50px;
    height: 8px;
    overflow: hidden;
  }

  .progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #ff9eb5, #ff6b9d);
    border-radius: 50px;
    transition: width 0.4s cubic-bezier(0.34,1.56,0.64,1);
  }

  .question-card {
    background: white;
    border-radius: 24px;
    padding: 32px 24px;
    box-shadow: var(--shadow);
    text-align: center;
    min-height: 160px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 12px;
    animation: slideIn 0.35s cubic-bezier(0.34,1.2,0.64,1);
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateX(40px) scale(0.97); }
    to   { opacity: 1; transform: translateX(0) scale(1); }
  }

  .q-icon {
    font-size: 40px;
  }

  .q-text {
    font-family: 'Kaisei Decol', serif;
    font-size: 20px;
    font-weight: 700;
    line-height: 1.6;
    color: var(--c-text);
  }

  .choices-grid {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .choice-btn {
    background: white;
    border: 2px solid #f0e8e4;
    border-radius: 16px;
    padding: 14px 20px;
    font-family: 'Zen Marugothic', sans-serif;
    font-size: 16px;
    color: var(--c-text);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.18s ease;
    text-align: left;
  }

  .choice-btn:hover {
    border-color: #ff9eb5;
    background: #fff5f8;
    transform: translateX(4px);
  }

  .choice-btn.selected {
    border-color: var(--c-accent);
    background: #fff0f5;
    color: var(--c-accent);
    font-weight: bold;
  }

  .choice-dot {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    font-weight: bold;
    flex-shrink: 0;
  }

  .dot-5 { background: #ffd6e7; color: #c0396a; }
  .dot-4 { background: #ffe4b5; color: #b05f00; }
  .dot-3 { background: #e8f0ff; color: #4a6aaa; }
  .dot-2 { background: #f0f0f0; color: #888; }
  .dot-1 { background: #e8ffe8; color: #3a8a3a; }

  .nav-area {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
  }

  .btn-prev {
    background: white;
    border: 2px solid #f0e8e4;
    border-radius: 50px;
    padding: 12px 24px;
    font-family: 'Zen Marugothic', sans-serif;
    font-size: 15px;
    color: var(--c-muted);
    cursor: pointer;
    transition: all 0.15s;
  }
  .btn-prev:hover { border-color: #ccc; color: var(--c-text); }
  .btn-prev:disabled { opacity: 0.3; cursor: not-allowed; }

  .btn-next {
    flex: 1;
    background: linear-gradient(135deg, #ff6b9d, #ff9eb5);
    color: white;
    border: none;
    border-radius: 50px;
    padding: 14px 24px;
    font-family: 'Kaisei Decol', serif;
    font-size: 17px;
    font-weight: 700;
    cursor: pointer;
    box-shadow: 0 4px 16px rgba(255,107,157,0.35);
    transition: all 0.15s;
    opacity: 0.4;
    pointer-events: none;
  }
  .btn-next.active {
    opacity: 1;
    pointer-events: all;
  }
  .btn-next.active:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(255,107,157,0.45); }

  /* â”€â”€â”€ RESULT SCREEN â”€â”€â”€ */
  #screen-result {
    display: none;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    padding-top: 32px;
    padding-bottom: 60px;
  }

  .result-label {
    font-size: 14px;
    color: var(--c-muted);
    letter-spacing: 0.15em;
    text-align: center;
  }

  .result-hero {
    width: 100%;
    border-radius: 28px;
    padding: 36px 28px;
    text-align: center;
    box-shadow: 0 8px 36px rgba(0,0,0,0.10);
    animation: popIn 0.5s cubic-bezier(0.34,1.56,0.64,1);
  }

  @keyframes popIn {
    from { opacity: 0; transform: scale(0.85); }
    to   { opacity: 1; transform: scale(1); }
  }

  .result-type-a { background: linear-gradient(135deg, #ffd6e7, #ffb3cc); }
  .result-type-b { background: linear-gradient(135deg, #c8e6ff, #9bd3ee); }
  .result-type-c { background: linear-gradient(135deg, #ffe5b4, #ffcf80); }
  .result-type-d { background: linear-gradient(135deg, #e8d5ff, #d0b8f5); }

  .result-icon {
    font-size: 72px;
    animation: wiggle 3s ease-in-out infinite;
  }

  @keyframes wiggle {
    0%, 100% { transform: rotate(-5deg); }
    50% { transform: rotate(5deg); }
  }

  .result-type-name {
    font-family: 'Kaisei Decol', serif;
    font-size: 26px;
    font-weight: 700;
    margin-top: 12px;
    color: var(--c-text);
  }

  .result-catch {
    font-size: 15px;
    line-height: 1.9;
    margin-top: 16px;
    color: var(--c-text);
    opacity: 0.85;
  }

  .result-details {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  .detail-card {
    background: white;
    border-radius: 20px;
    padding: 20px;
    box-shadow: var(--shadow);
  }

  .detail-card-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
  }

  .detail-tag {
    font-size: 11px;
    font-weight: bold;
    letter-spacing: 0.12em;
    padding: 4px 10px;
    border-radius: 50px;
  }
  .tag-a { background: var(--c-hotoko-light); color: #c0396a; }
  .tag-b { background: var(--c-hirameki-light); color: #2a7a96; }
  .tag-c { background: var(--c-spicy-light); color: #b05f00; }

  .detail-card p {
    font-size: 14px;
    line-height: 1.9;
    color: var(--c-text);
  }

  /* ãƒ¬ãƒ¼ãƒ€ãƒ¼é¢¨ã‚¹ã‚³ã‚¢ */
  .score-card {
    background: white;
    border-radius: 20px;
    padding: 20px;
    box-shadow: var(--shadow);
    width: 100%;
  }

  .score-title {
    font-size: 13px;
    font-weight: bold;
    color: var(--c-muted);
    letter-spacing: 0.1em;
    margin-bottom: 16px;
    text-align: center;
  }

  .score-bars {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .score-row {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .score-label {
    font-size: 13px;
    width: 100px;
    flex-shrink: 0;
    color: var(--c-text);
  }

  .score-bar-bg {
    flex: 1;
    height: 10px;
    background: #f0e8e4;
    border-radius: 50px;
    overflow: hidden;
  }

  .score-bar-fill {
    height: 100%;
    border-radius: 50px;
    transition: width 1s cubic-bezier(0.34,1.2,0.64,1);
  }

  .fill-a { background: linear-gradient(90deg, #ff9eb5, #ff6b9d); }
  .fill-b { background: linear-gradient(90deg, #7ec8e3, #4ab0d0); }
  .fill-c { background: linear-gradient(90deg, #ffb347, #ff8c00); }
  .fill-d { background: linear-gradient(90deg, #b59fdb, #9370c8); }

  .score-pct {
    font-size: 12px;
    font-weight: bold;
    width: 32px;
    text-align: right;
    color: var(--c-muted);
  }

  .share-card {
    background: white;
    border-radius: 20px;
    padding: 20px;
    box-shadow: var(--shadow);
    width: 100%;
    text-align: center;
  }

  .share-title {
    font-size: 13px;
    color: var(--c-muted);
    letter-spacing: 0.1em;
    margin-bottom: 12px;
  }

  .share-text-box {
    background: #faf8f6;
    border: 1.5px dashed #f0c8d8;
    border-radius: 14px;
    padding: 16px;
    font-size: 14px;
    line-height: 1.8;
    color: var(--c-text);
    margin-bottom: 14px;
    cursor: pointer;
    transition: background 0.2s;
  }
  .share-text-box:hover { background: #fff0f5; }

  .btn-copy {
    background: linear-gradient(135deg, #ff6b9d, #ff9eb5);
    color: white;
    border: none;
    border-radius: 50px;
    padding: 12px 32px;
    font-family: 'Zen Marugothic', sans-serif;
    font-size: 15px;
    font-weight: bold;
    cursor: pointer;
    width: 100%;
    transition: all 0.15s;
    box-shadow: 0 4px 16px rgba(255,107,157,0.3);
  }
  .btn-copy:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(255,107,157,0.4); }

  .copy-done {
    font-size: 13px;
    color: #3aaa3a;
    margin-top: 8px;
    opacity: 0;
    transition: opacity 0.3s;
  }

  .btn-retry {
    background: white;
    border: 2px solid #f0e8e4;
    border-radius: 50px;
    padding: 12px 32px;
    font-family: 'Zen Marugothic', sans-serif;
    font-size: 15px;
    color: var(--c-muted);
    cursor: pointer;
    width: 100%;
    transition: all 0.15s;
  }
  .btn-retry:hover { border-color: #ff9eb5; color: var(--c-accent); }

  /* â”€â”€â”€ ã‚µãƒ–ã‚¿ã‚¤ãƒ—è¡¨ç¤º â”€â”€â”€ */
  .sub-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: white;
    border-radius: 50px;
    padding: 6px 16px;
    font-size: 13px;
    font-weight: bold;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    margin-top: 12px;
  }

  /* â”€â”€â”€ Loading â”€â”€â”€ */
  #screen-loading {
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    gap: 20px;
    text-align: center;
  }

  .loading-emoji {
    font-size: 56px;
    animation: spin 1.2s linear infinite;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to   { transform: rotate(360deg); }
  }

  .loading-text {
    font-family: 'Kaisei Decol', serif;
    font-size: 20px;
    color: var(--c-text);
    animation: pulse 1.5s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  .floaty {
    position: fixed;
    pointer-events: none;
    font-size: 24px;
    animation: floatUp 3s ease-out forwards;
    z-index: 999;
  }

  @keyframes floatUp {
    from { opacity: 1; transform: translateY(0) scale(1); }
    to   { opacity: 0; transform: translateY(-120px) scale(1.4); }
  }

  /* â”€â”€â”€ ã‚µãƒ–åŒç‚¹æ™‚ â”€â”€â”€ */
  .tied-note {
    font-size: 13px;
    color: var(--c-muted);
    background: white;
    border-radius: 12px;
    padding: 12px 16px;
    width: 100%;
    text-align: center;
    box-shadow: var(--shadow);
    line-height: 1.8;
  }

</style>

<!-- Firebase SDK (compat version) -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="../firebase-common.js"></script>
</head>
<body>
<div class="wrapper">

  <!-- â”€â”€â”€ START â”€â”€â”€ -->
  <div id="screen-start">
    <div class="logo-area">
      <div class="logo-emoji">ğŸ˜‚</div>
      <div class="title-main">ã‚ã‚‰ã„ã®ãƒ„ãƒœ<br>è¨ºæ–­</div>
      <div class="title-sub">ã‚ãªãŸã®ã€Œç¬‘ã„ã€ã®ã‚¯ã‚»ã€çŸ¥ã£ã¦ã¿ã‚ˆã†</div>
    </div>

    <div class="start-card">
      <p>å…¨éƒ¨ã§ <strong>20å•</strong>ã€‚<br>ç›´æ„Ÿã§ã‚µã‚¯ã‚µã‚¯ç­”ãˆã‚‹ã®ãŒã‚³ãƒ„ï¼<br>ã‚ãªãŸã®ç¬‘ã„ã®ãƒ„ãƒœã€4ã‚¿ã‚¤ãƒ—ã‹ã‚‰è¦‹ã¤ã‘ã¾ã™âœ¨</p>
      <div class="type-preview">
        <div class="type-chip chip-a">ğŸŒ¸ ã»ã£ã“ã‚Šå…±æ„Ÿ</div>
        <div class="type-chip chip-b">ğŸ’¡ ã²ã‚‰ã‚ãæ§‹é€ </div>
        <div class="type-chip chip-c">ğŸŒ¶ ãƒ”ãƒªè¾›ã‚¹ãƒ‘ã‚¤ã‚¹</div>
        <div class="type-chip chip-d">ğŸŒ€ ãµã—ãã‚«ã‚ªã‚¹</div>
      </div>
    </div>

    <button class="btn-start" onclick="startQuiz()">è¨ºæ–­ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
    <div class="note-text">æ‰€è¦æ™‚é–“ï¼šç´„3ã€œ5åˆ†</div>
  </div>

  <!-- â”€â”€â”€ QUIZ â”€â”€â”€ -->
  <div id="screen-quiz">
    <div class="quiz-header">
      <div class="quiz-count" id="quiz-count">Q1 / 20</div>
      <div class="progress-bar-wrap">
        <div class="progress-bar-fill" id="progress-fill" style="width:5%"></div>
      </div>
    </div>

    <div class="question-card" id="question-card">
      <div class="q-icon" id="q-icon">ğŸ˜Š</div>
      <div class="q-text" id="q-text">è³ªå•æ–‡</div>
    </div>

    <div class="choices-grid" id="choices-grid">
      <button class="choice-btn" onclick="selectChoice(5)">
        <span class="choice-dot dot-5">â˜…â˜…</span>ã¨ã¦ã‚‚ãã†æ€ã†
      </button>
      <button class="choice-btn" onclick="selectChoice(4)">
        <span class="choice-dot dot-4">â˜…</span>ã‚„ã‚„ãã†æ€ã†
      </button>
      <button class="choice-btn" onclick="selectChoice(3)">
        <span class="choice-dot dot-3">ã€œ</span>ã©ã¡ã‚‰ã§ã‚‚ãªã„
      </button>
      <button class="choice-btn" onclick="selectChoice(2)">
        <span class="choice-dot dot-2">â–³</span>ã‚ã¾ã‚Šãã†æ€ã‚ãªã„
      </button>
      <button class="choice-btn" onclick="selectChoice(1)">
        <span class="choice-dot dot-1">âœ—</span>ã¾ã£ãŸããã†æ€ã‚ãªã„
      </button>
    </div>

    <div class="nav-area">
      <button class="btn-prev" id="btn-prev" onclick="prevQuestion()" disabled>â† ã‚‚ã©ã‚‹</button>
      <button class="btn-next" id="btn-next" onclick="nextQuestion()">ã¤ãã¸ â†’</button>
    </div>
  </div>

  <!-- â”€â”€â”€ LOADING â”€â”€â”€ -->
  <div id="screen-loading">
    <div class="loading-emoji">ğŸ”</div>
    <div class="loading-text">ã‚ãªãŸã®ç¬‘ã„ã®ãƒ„ãƒœã‚’<br>åˆ†æä¸­â€¦</div>
  </div>

  <!-- â”€â”€â”€ RESULT â”€â”€â”€ -->
  <div id="screen-result">
    <div class="result-label">âœ¨ è¨ºæ–­çµæœ âœ¨</div>

    <div class="result-hero" id="result-hero">
      <div class="result-icon" id="result-icon">ğŸŒ¸</div>
      <div class="result-type-name" id="result-type-name">ã»ã£ã“ã‚Šå…±æ„Ÿã‚¿ã‚¤ãƒ—</div>
      <div class="result-catch" id="result-catch">ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼</div>
      <div id="sub-badge-area"></div>
    </div>

    <div class="result-details" id="result-details"></div>

    <div class="score-card">
      <div class="score-title">ã‚ãªãŸã®ç¬‘ã„ã®ãƒãƒ©ãƒ³ã‚¹</div>
      <div class="score-bars" id="score-bars"></div>
    </div>

    <div id="tied-note-area"></div>

    <div class="share-card">
      <div class="share-title">ğŸ“² ã‚·ã‚§ã‚¢ç”¨ãƒ†ã‚­ã‚¹ãƒˆ</div>
      <div class="share-text-box" id="share-text" onclick="copyShare()"></div>
      <button class="btn-copy" onclick="copyShare()">ã‚³ãƒ”ãƒ¼ã™ã‚‹</button>
      <div class="copy-done" id="copy-done">âœ… ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼</div>
    </div>

    <button class="btn-retry" onclick="location.href='../index.html'">â† ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹</button>
    <button class="btn-retry" onclick="retryQuiz()">ğŸ”„ ã‚‚ã†ã„ã¡ã©è¨ºæ–­ã™ã‚‹</button>
  </div>

</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ã‚¿ã‚¤ãƒ—ãƒ‡ãƒ¼ã‚¿
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TYPES = {
  A: {
    key: 'A',
    name: 'ã»ã£ã“ã‚Šå…±æ„Ÿã‚¿ã‚¤ãƒ—',
    icon: 'ğŸŒ¸',
    heroClass: 'result-type-a',
    catch: 'ã€Œã¿ã‚“ãªã§ç¬‘ãˆã‚‹ã€ãŒã„ã¡ã°ã‚“å¤§äº‹ã€‚\nç©ºæ°—ãŒã‚„ã‚ã‚‰ãç¬é–“ãŒå¥½ãã€‚\nå®‰å¿ƒã§ãã‚‹ç¬‘ã„ã«å¿ƒãŒå‹•ãã¾ã™ã€‚',
    details: [
      {
        tag: 'ç¬‘ã„ã®ã‚¹ã‚¿ã‚¤ãƒ«',
        tagClass: 'tag-a',
        body: 'æ—¥å¸¸ã®ã€Œã‚ã‚‹ã‚ã‚‹ã€ã§ã‚¯ã‚¹ã£ã¨ã™ã‚‹ã®ãŒå¾—æ„ã€‚èª°ã‹ãŒç¬‘ãˆã°è‡ªåˆ†ã‚‚ç¬‘ãˆã‚‹ã—ã€ã¿ã‚“ãªãŒæ°—æŒã¡ã‚ˆããªã‚‹ç¬é–“ã‚’è‡ªç„¶ã«å¤§åˆ‡ã«ã—ã¦ã„ã¾ã™ã€‚'
      },
      {
        tag: 'äººã¨ã®é–¢ã‚ã‚Šæ–¹',
        tagClass: 'tag-b',
        body: 'å ´ã®ç©ºæ°—ã‚’èª­ã‚€åŠ›ãŒé«˜ãã€å‘¨ã‚Šã‚’ã»ã£ã¨ã•ã›ã‚‹å­˜åœ¨ã§ã™ã€‚ç¬‘ã„ã‚’é€šã˜ã¦ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹ã®ãŒã¨ã¦ã‚‚ä¸Šæ‰‹ã€‚'
      },
      {
        tag: 'ãƒ„ãƒœã®æ·±ã‚æ–¹',
        tagClass: 'tag-c',
        body: 'ã¡ã‚‡ã£ã¨ã—ãŸæ—¥å¸¸ã®ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã€å®¶æ—ã‚„å‹äººã¨ã®å°ã•ãªå‡ºæ¥äº‹ã€‚ãã†ã„ã†ã¨ã“ã‚ã«ç´ ç›´ã«ç¬‘ãˆã‚‹æ„Ÿæ€§ãŒã‚ãªãŸã®æ­¦å™¨ã§ã™ã€‚'
      }
    ],
    share: 'è¨ºæ–­ã—ãŸã‚‰ã€ŒğŸŒ¸ ã»ã£ã“ã‚Šå…±æ„Ÿã‚¿ã‚¤ãƒ—ã€ã§ã—ãŸï¼ã¿ã‚“ãªã§ç¬‘ãˆã‚‹ã“ã¨ãŒå¤§å¥½ãã€‚ã‚ãªãŸã¯ä½•ã‚¿ã‚¤ãƒ—ï¼Ÿ #ã‚ã‚‰ã„ã®ãƒ„ãƒœè¨ºæ–­'
  },
  B: {
    key: 'B',
    name: 'ã²ã‚‰ã‚ãæ§‹é€ ã‚¿ã‚¤ãƒ—',
    icon: 'ğŸ’¡',
    heroClass: 'result-type-b',
    catch: 'ãƒã‚¿ã®ã€Œä»•çµ„ã¿ã€ãŒè¦‹ãˆãŸã¨ãã€\nã²ã¨ã‚Šã§ã«ã‚„ã£ã¨ã™ã‚‹ã‚¿ã‚¤ãƒ—ã€‚\nçŸ¥çš„ã§ã‚¯ãƒ¼ãƒ«ãªç¬‘ã„ã®æŒã¡ä¸»ã§ã™ã€‚',
    details: [
      {
        tag: 'ç¬‘ã„ã®ã‚¹ã‚¿ã‚¤ãƒ«',
        tagClass: 'tag-a',
        body: 'ã“ã¨ã°ã®ã‚ºãƒ¬ã‚„ä¼ç·šã®å›åã«é‹­ãåå¿œã—ã¾ã™ã€‚ã€Œã‚ã€ãã†ã„ã†ã“ã¨ã‹ï¼ã€ã¨ã„ã†ç¬é–“ã®å¿«æ„ŸãŒå¤§å¥½ãã€‚ãƒã‚¿ã‚’"è§£èª­"ã™ã‚‹ã®ãŒæ¥½ã—ã„ã€‚'
      },
      {
        tag: 'äººã¨ã®é–¢ã‚ã‚Šæ–¹',
        tagClass: 'tag-b',
        body: 'ã•ã‚Šã’ãªãã„ã„çªã£è¾¼ã¿ã‚’å…¥ã‚ŒãŸã‚Šã€ã¿ã‚“ãªãŒè¦‹è½ã¨ã—ãŸã€Œã‚ºãƒ¬ã€ã«æ°—ã¥ãè¦³å¯Ÿçœ¼ãŒã‚ã‚Šã¾ã™ã€‚ã‚»ãƒ³ã‚¹ãŒã„ã„ã¨è¨€ã‚ã‚Œã‚‹ã“ã¨ã‚‚å¤šã„ã¯ãšã€‚'
      },
      {
        tag: 'ãƒ„ãƒœã®æ·±ã‚æ–¹',
        tagClass: 'tag-c',
        body: 'ã²ã¨ã²ã­ã‚Šãã„ãŸæ˜ åƒã€è¨€è‘‰éŠã³ã®ã‚ã‚‹æ–‡ç« ã€ã¡ã‚‡ã£ã¨æ·±èª­ã¿ã—ãŸããªã‚‹ã‚³ãƒ³ãƒˆâ€¦ãã†ã„ã†ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã§ã‚ãªãŸã®ç¬‘ã„ã®ã‚¢ãƒ³ãƒ†ãƒŠã¯å…¨é–‹ã«ãªã‚Šã¾ã™ã€‚'
      }
    ],
    share: 'è¨ºæ–­ã—ãŸã‚‰ã€ŒğŸ’¡ ã²ã‚‰ã‚ãæ§‹é€ ã‚¿ã‚¤ãƒ—ã€ã§ã—ãŸï¼ãƒã‚¿ã®ä»•çµ„ã¿ã‚’ç†è§£ã—ãŸã¨ãã«ã²ã¨ã‚Šã§ã«ã‚„ã£ã¨ã™ã‚‹æ´¾ã€‚ã‚ãªãŸã¯ï¼Ÿ #ã‚ã‚‰ã„ã®ãƒ„ãƒœè¨ºæ–­'
  },
  C: {
    key: 'C',
    name: 'ãƒ”ãƒªè¾›ã‚¹ãƒ‘ã‚¤ã‚¹ã‚¿ã‚¤ãƒ—',
    icon: 'ğŸŒ¶',
    heroClass: 'result-type-c',
    catch: 'åˆºæ¿€ã¨è§£æ”¾æ„ŸãŒç¬‘ã„ã®ã‚¹ãƒ‘ã‚¤ã‚¹ã€‚\nã¡ã‚‡ã£ã¨ãƒ’ãƒ¤ãƒƒã¨ã™ã‚‹ãƒã‚¿ã‚‚å¹³æ°—ã€‚\næ”»ã‚ãŸç¬‘ã„ã‚‚æ¥½ã—ã‚ã‚‹å¼·ã„ã‚¿ã‚¤ãƒ—ã€‚',
    details: [
      {
        tag: 'ç¬‘ã„ã®ã‚¹ã‚¿ã‚¤ãƒ«',
        tagClass: 'tag-a',
        body: 'å°‘ã—ãƒ‰ã‚­ãƒƒã¨ã™ã‚‹ã‚ˆã†ãªãƒã‚¿ã€ç·Šå¼µæ„Ÿã®ã‚ã‚‹ã‚·ãƒ¼ãƒ³ã€ãã“ã‹ã‚‰ã®çˆ†ç™ºçš„ãªç¬‘ã„ã€‚ãã®ç·©æ€¥ãŒãŸã¾ã‚‰ãªã„ã¨æ„Ÿã˜ã¦ã„ã¾ã™ã€‚'
      },
      {
        tag: 'äººã¨ã®é–¢ã‚ã‚Šæ–¹',
        tagClass: 'tag-b',
        body: 'ç¬‘ã„ã®ã€Œã‚ªãƒã€ã«å‘ã‹ã£ã¦å¼•ã£å¼µã‚‹åŠ›ãŒã‚ã‚Šã€å ´ã®ç†±é‡ã‚’ä¸Šã’ã‚‹ã“ã¨ãŒå¾—æ„ã€‚å¤§èƒ†ãªç¬‘ã„ã«æ€¯ã¾ãªã„åº¦èƒ¸ãŒã‚ã‚Šã¾ã™ã€‚'
      },
      {
        tag: 'ãƒ„ãƒœã®æ·±ã‚æ–¹',
        tagClass: 'tag-c',
        body: 'å°‘ã—ã‚¢ã‚¦ãƒˆãªç©ºæ°—æ„Ÿã‚‚ç¬‘ã„ã«å¤‰ãˆã‚‰ã‚Œã‚‹è¨±å®¹ç¯„å›²ã®åºƒã•ãŒå¼·ã¿ã€‚ãŸã ã€Œé¢ç™½ã‘ã‚Œã°ãªã‚“ã§ã‚‚ã„ã„ã€ã§ã¯ãªãã€ç¬‘ã„ã®ãƒãƒ©ãƒ³ã‚¹æ„Ÿè¦šã‚‚ã¡ã‚ƒã‚“ã¨æŒã£ã¦ã„ã¾ã™ã€‚'
      }
    ],
    share: 'è¨ºæ–­ã—ãŸã‚‰ã€ŒğŸŒ¶ ãƒ”ãƒªè¾›ã‚¹ãƒ‘ã‚¤ã‚¹ã‚¿ã‚¤ãƒ—ã€ã§ã—ãŸï¼ã¡ã‚‡ã£ã¨æ”»ã‚ãŸç¬‘ã„ã‚‚å¹³æ°—ãªãƒ‰ã‚­ãƒ‰ã‚­ç³»ã€‚ã‚ãªãŸã®ã‚¿ã‚¤ãƒ—ã¯ï¼Ÿ #ã‚ã‚‰ã„ã®ãƒ„ãƒœè¨ºæ–­'
  },
  D: {
    key: 'D',
    name: 'ãµã—ãã‚«ã‚ªã‚¹ã‚¿ã‚¤ãƒ—',
    icon: 'ğŸŒ€',
    heroClass: 'result-type-d',
    catch: 'èª¬æ˜ã§ããªã„ã®ã«ç¬‘ãˆã‚‹ã€‚\nãã‚ŒãŒã„ã¡ã°ã‚“æœ€é«˜ã ã¨çŸ¥ã£ã¦ã„ã‚‹ã€‚\nç¬‘ã„ã®å®‡å®™äººã€æœ€å‰ç·šã‚’è¡Œãäººã€‚',
    details: [
      {
        tag: 'ç¬‘ã„ã®ã‚¹ã‚¿ã‚¤ãƒ«',
        tagClass: 'tag-a',
        body: 'ã€Œã“ã‚Œä½•ãŒãŠã‚‚ã—ã‚ã„ã®ï¼Ÿã€ã¨èã‹ã‚Œã¦ã‚‚ç­”ãˆã‚‰ã‚Œãªã„ã®ã«ã€ãªãœã‹ãƒ„ãƒœã«ã¯ã¾ã‚‹ã€‚ä¸æ¡ç†ãªã‚ã®æ„Ÿã˜ãŒæœ€é«˜ã®ç¬‘ã„ã ã¨çŸ¥ã£ã¦ã„ã¾ã™ã€‚'
      },
      {
        tag: 'äººã¨ã®é–¢ã‚ã‚Šæ–¹',
        tagClass: 'tag-b',
        body: 'ç¬‘ã„ã®ã‚»ãƒ³ã‚µãƒ¼ãŒç‹¬ç‰¹ãªã®ã§ã€ã¿ã‚“ãªãŒç¬‘ã‚ãªã„ã¨ã“ã‚ã§å…ˆã«åå¿œã™ã‚‹ã“ã¨ã‚‚ã€‚å°‘ã—å¤‰ã‚ã£ãŸãƒ¦ãƒ¼ãƒ¢ã‚¢ã®æŒã¡ä¸»ã¨ã—ã¦å€‹æ€§çš„ãªå­˜åœ¨æ„ŸãŒã‚ã‚Šã¾ã™ã€‚'
      },
      {
        tag: 'ãƒ„ãƒœã®æ·±ã‚æ–¹',
        tagClass: 'tag-c',
        body: 'çªç„¶ã®å±•é–‹ã€æ„å‘³ã®ãªã•ãã†ãªè¨€è‘‰ã®é€£ãªã‚Šã€èª¬æ˜ä¸èƒ½ãªã‚·ãƒ¥ãƒ¼ãƒ«ãªæ˜ åƒâ€¦ãã†ã„ã†ã‚«ã‚ªã‚¹ã®ä¸­ã«ã‚ãªãŸã¯ç¬‘ã„ã®ç¥æ§˜ã‚’è¦‹ã¦ã„ã¾ã™ã€‚'
      }
    ],
    share: 'è¨ºæ–­ã—ãŸã‚‰ã€ŒğŸŒ€ ãµã—ãã‚«ã‚ªã‚¹ã‚¿ã‚¤ãƒ—ã€ã§ã—ãŸï¼èª¬æ˜ã§ããªã„ã®ã«ç¬‘ãˆã‚‹ã‚·ãƒ¥ãƒ¼ãƒ«èŠ¸äººã‚¿ã‚¤ãƒ—ã€‚ã‚ãªãŸã¯ï¼Ÿ #ã‚ã‚‰ã„ã®ãƒ„ãƒœè¨ºæ–­'
  }
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  è³ªå•ãƒ‡ãƒ¼ã‚¿ï¼ˆå„ã‚¿ã‚¤ãƒ—5å•ï¼‰
//  type: A=ã»ã£ã“ã‚Š, B=ã²ã‚‰ã‚ã, C=ã‚¹ãƒ‘ã‚¤ã‚¹, D=ã‚«ã‚ªã‚¹
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const QUESTIONS = [
  // â”€â”€ A: ã»ã£ã“ã‚Šå…±æ„Ÿ â”€â”€
  { type:'A', icon:'ğŸ˜Š', text:'å‹é”ã®"ã‚ã‚‹ã‚ã‚‹è©±"ã§ã‚ˆãç¬‘ã†' },
  { type:'A', icon:'ğŸ¤', text:'å ´ã®ç©ºæ°—ãŒã‚„ã‚ã‚‰ãç¬‘ã„ãŒå¥½ã' },
  { type:'A', icon:'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§', text:'å®¶æ—ã‚„å‹äººã®æ—¥å¸¸è©±ã§ç¬‘ãˆã‚‹ã“ã¨ãŒå¤šã„' },
  { type:'A', icon:'ğŸ˜Œ', text:'èª°ã‚‚å‚·ã¤ã‹ãªã„ç¬‘ã„ã«ã„ã¡ã°ã‚“å®‰å¿ƒã™ã‚‹' },
  { type:'A', icon:'ğŸŒ·', text:'ã€Œåˆ†ã‹ã‚‹ï¼ã€ã¨å…±æ„Ÿã§ãã‚‹ãƒã‚¿ã«å¼±ã„' },

  // â”€â”€ B: ã²ã‚‰ã‚ãæ§‹é€  â”€â”€
  { type:'B', icon:'ğŸ¯', text:'ä¼ç·šãŒå›åã•ã‚Œã‚‹ç¬é–“ãŒæ°—æŒã¡ã„ã„' },
  { type:'B', icon:'ğŸ§ ', text:'ã“ã¨ã°ã®äºŒé‡ã®æ„å‘³ã«æ°—ã¥ã„ã¦ç¬‘ã†ã“ã¨ãŒå¤šã„' },
  { type:'B', icon:'ğŸ”', text:'ãƒã‚¿ã®ã€Œæ§‹é€ ã€ã‚’ç†è§£ã™ã‚‹ã¨ä½™è¨ˆãŠã‹ã—ã„' },
  { type:'B', icon:'ğŸ’¬', text:'çš®è‚‰ã‚„ã¡ã‚‡ã£ã¨ã—ãŸãƒ¡ã‚¿ãªã‚®ãƒ£ã‚°ãŒå¥½ã' },
  { type:'B', icon:'ğŸª', text:'ã²ã¨ã²ã­ã‚Šãã„ãŸã‚ªãƒãŒãªã„ã¨ç‰©è¶³ã‚Šãªã„' },

  // â”€â”€ C: ãƒ”ãƒªè¾›ã‚¹ãƒ‘ã‚¤ã‚¹ â”€â”€
  { type:'C', icon:'ğŸŒ¶', text:'ã¡ã‚‡ã£ã¨æ¯’ã®ã‚ã‚‹ãƒã‚¿ã‚‚ç¬‘ãˆã‚‹' },
  { type:'C', icon:'âš¡', text:'ç·Šå¼µæ„ŸãŒã‚ã£ã¦ã‹ã‚‰ã®ã‚ªãƒãŒæœ€é«˜ã«å¥½ã' },
  { type:'C', icon:'ğŸ­', text:'å°‘ã—æ”»ã‚ãŸã‚¸ãƒ§ãƒ¼ã‚¯ã‚‚æ¥½ã—ã‚ã‚‹ã»ã†ã ' },
  { type:'C', icon:'ğŸ”¥', text:'ãƒ‰ã‚­ãƒƒã¨ã—ãŸå¾Œã«ç¬‘ãˆã‚‹ãƒã‚¿ãŒç™–ã«ãªã‚‹' },
  { type:'C', icon:'ğŸ’£', text:'ã‚¿ãƒ–ãƒ¼ç ´ã‚Šã®ãƒ¦ãƒ¼ãƒ¢ã‚¢ã«ã‚‚ç¬‘ãˆã‚‹ã“ã¨ãŒã‚ã‚‹' },

  // â”€â”€ D: ãµã—ãã‚«ã‚ªã‚¹ â”€â”€
  { type:'D', icon:'ğŸŒ€', text:'æ„å‘³ãŒåˆ†ã‹ã‚‰ãªã„å‹•ç”»ã§ç¬‘ã†ã“ã¨ãŒã‚ã‚‹' },
  { type:'D', icon:'ğŸ‘½', text:'ãªãœé¢ç™½ã„ã‹èª¬æ˜ã§ããªã„ã‚‚ã®ã«ä¸€ç•ªç¬‘ã†' },
  { type:'D', icon:'ğŸ²', text:'çªç„¶ã®å±•é–‹ã‚„äºˆæƒ³å¤–ã®æµã‚ŒãŒå¤§å¥½ã' },
  { type:'D', icon:'ğŸŒˆ', text:'ä¸æ¡ç†ã§ã‚·ãƒ¥ãƒ¼ãƒ«ãªã‚®ãƒ£ã‚°ã«å¼±ã„' },
  { type:'D', icon:'ğŸ« ', text:'ã€Œã“ã‚Œã¯ä½•ï¼Ÿã€ã¨ã„ã†å‹•ç”»ã§ãƒ„ãƒœã«ã¯ã¾ã‚‹' },
];

// ãƒ©ãƒ³ãƒ€ãƒ ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼ˆFisher-Yatesï¼‰
function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  çŠ¶æ…‹ç®¡ç†
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let shuffledQ = [];
let currentIdx = 0;
let answers = [];
let selectedValue = null;

function startQuiz() {
  shuffledQ = shuffle(QUESTIONS);
  answers = new Array(20).fill(null);
  currentIdx = 0;
  selectedValue = null;
  showQuestion();
  switchScreen('quiz');
}

function showQuestion() {
  const q = shuffledQ[currentIdx];
  document.getElementById('q-icon').textContent = q.icon;
  document.getElementById('q-text').textContent = q.text;
  document.getElementById('quiz-count').textContent = `Q${currentIdx+1} / 20`;
  document.getElementById('progress-fill').style.width = `${((currentIdx+1)/20)*100}%`;

  // ãƒœã‚¿ãƒ³ã®ãƒªã‚»ãƒƒãƒˆ
  const btns = document.querySelectorAll('.choice-btn');
  btns.forEach(btn => btn.classList.remove('selected'));
  document.getElementById('btn-prev').disabled = currentIdx === 0;

  // æ—¢å­˜å›ç­”ã®å¾©å…ƒ
  selectedValue = answers[currentIdx];
  const valueMap = [5,4,3,2,1];
  if (selectedValue !== null) {
    btns.forEach((btn, i) => {
      if (valueMap[i] === selectedValue) btn.classList.add('selected');
    });
    enableNext(true);
  } else {
    enableNext(false);
  }

  // ã‚«ãƒ¼ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  const card = document.getElementById('question-card');
  card.style.animation = 'none';
  void card.offsetWidth;
  card.style.animation = 'slideIn 0.35s cubic-bezier(0.34,1.2,0.64,1)';
}

function selectChoice(value) {
  selectedValue = value;
  answers[currentIdx] = value;

  const btns = document.querySelectorAll('.choice-btn');
  const valueMap = [5,4,3,2,1];
  btns.forEach((btn, i) => {
    btn.classList.toggle('selected', valueMap[i] === value);
  });

  enableNext(true);

  // ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡
  const emojis = ['ğŸ˜‚','ğŸ¤£','ğŸ˜†','ğŸ¥¹','ğŸ˜„','âœ¨','ğŸ‘'];
  const el = document.createElement('div');
  el.className = 'floaty';
  el.textContent = emojis[Math.floor(Math.random()*emojis.length)];
  el.style.left = (Math.random() * 60 + 20) + '%';
  el.style.bottom = '20%';
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3100);

  // 500mså¾Œã«è‡ªå‹•é€²è¡Œï¼ˆUXå‘ä¸Šï¼‰
  setTimeout(() => {
    if (answers[currentIdx] === value) nextQuestion();
  }, 500);
}

function enableNext(on) {
  const btn = document.getElementById('btn-next');
  btn.classList.toggle('active', on);
  btn.textContent = currentIdx === 19 ? 'çµæœã‚’è¦‹ã‚‹ âœ¨' : 'ã¤ãã¸ â†’';
}

function nextQuestion() {
  if (answers[currentIdx] === null) return;
  if (currentIdx < 19) {
    currentIdx++;
    showQuestion();
  } else {
    showLoading();
  }
}

function prevQuestion() {
  if (currentIdx > 0) {
    currentIdx--;
    showQuestion();
  }
}

async function showLoading() {
  switchScreen('loading');
  setTimeout(async () => await showResult(), 1800);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ã‚¹ã‚³ã‚¢è¨ˆç®—
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcScores() {
  const scores = { A:0, B:0, C:0, D:0 };
  shuffledQ.forEach((q, i) => {
    if (answers[i] !== null) scores[q.type] += answers[i];
  });
  return scores;
}

function getTopType(scores) {
  return Object.entries(scores).sort((a,b) => b[1]-a[1])[0][0];
}

async function showResult() {
  const scores = calcScores();
  const topKey = getTopType(scores);
  const type = TYPES[topKey];
  const maxPossible = 5 * 5; // 5å•Ã—5ç‚¹

  // ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚«ãƒ¼ãƒ‰
  const hero = document.getElementById('result-hero');
  hero.className = `result-hero ${type.heroClass}`;
  document.getElementById('result-icon').textContent = type.icon;
  document.getElementById('result-type-name').textContent = type.name;
  document.getElementById('result-catch').textContent = type.catch;

  // åŒç‚¹ã‚µãƒ–ãƒãƒƒã‚¸
  const subArea = document.getElementById('sub-badge-area');
  subArea.innerHTML = '';
  const sortedScores = Object.entries(scores).sort((a,b) => b[1]-a[1]);
  const topScore = sortedScores[0][1];
  const ties = sortedScores.filter(s => s[1] === topScore);
  if (ties.length > 1) {
    const subKey = ties.find(t => t[0] !== topKey)?.[0];
    if (subKey) {
      const sub = TYPES[subKey];
      subArea.innerHTML = `<div class="sub-badge">${sub.icon} ${sub.name}ã®è¦ç´ ã‚‚ï¼</div>`;
    }
  }

  // è©³ç´°ã‚«ãƒ¼ãƒ‰
  const detailsEl = document.getElementById('result-details');
  detailsEl.innerHTML = type.details.map(d => `
    <div class="detail-card">
      <div class="detail-card-header">
        <span class="detail-tag ${d.tagClass}">${d.tag}</span>
      </div>
      <p>${d.body}</p>
    </div>
  `).join('');

  // ã‚¹ã‚³ã‚¢ãƒãƒ¼
  const barsEl = document.getElementById('score-bars');
  const fillClass = { A:'fill-a', B:'fill-b', C:'fill-c', D:'fill-d' };
  const typeDisplay = { A:TYPES.A.name, B:TYPES.B.name, C:TYPES.C.name, D:TYPES.D.name };
  const typeIcon = { A:TYPES.A.icon, B:TYPES.B.icon, C:TYPES.C.icon, D:TYPES.D.icon };
  barsEl.innerHTML = Object.entries(scores).sort((a,b)=>b[1]-a[1]).map(([k,v]) => {
    const pct = Math.round((v / maxPossible) * 100);
    return `
      <div class="score-row">
        <div class="score-label">${typeIcon[k]} ${typeDisplay[k].replace('ã‚¿ã‚¤ãƒ—','')}</div>
        <div class="score-bar-bg">
          <div class="score-bar-fill ${fillClass[k]}" style="width:0%" data-target="${pct}%"></div>
        </div>
        <div class="score-pct">${pct}%</div>
      </div>
    `;
  }).join('');

  // åŒç‚¹æ³¨é‡ˆ
  const tiedArea = document.getElementById('tied-note-area');
  tiedArea.innerHTML = '';
  if (ties.length > 1) {
    const names = ties.map(t => `${TYPES[t[0]].icon}${TYPES[t[0]].name}`).join('ãƒ»');
    tiedArea.innerHTML = `<div class="tied-note">âœ¨ ${names}ãŒåŒç‚¹ã§ã—ãŸï¼<br>ã‚ãªãŸã¯ã©ã¡ã‚‰ã®è¦ç´ ã‚‚æŒã¤è¤‡åˆã‚¿ã‚¤ãƒ—ã§ã™ã€‚</div>`;
  }

  // ã‚·ã‚§ã‚¢ãƒ†ã‚­ã‚¹ãƒˆ
  document.getElementById('share-text').textContent = type.share;

  switchScreen('result');

  // ãƒãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  setTimeout(() => {
    document.querySelectorAll('.score-bar-fill').forEach(el => {
      el.style.width = el.dataset.target;
    });
  }, 300);

  // Save diagnosis result to Firestore
  if (window.saveDiagnosisResult) {
    // èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ã‹ã‚‰ä¿å­˜
    const currentUser = window.getCurrentUser ? window.getCurrentUser() : null;
    if (!currentUser) {
      console.log('ğŸ” èªè¨¼çŠ¶æ…‹ã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã—ã¾ã™...');
      if (window.refreshAuthState) {
        await window.refreshAuthState();
      }
    }
    
    window.saveDiagnosisResult({
      diagnosisId: "uniquetype",
      diagnosisTitle: "ã‚ã‚‰ã„ã®ãƒ„ãƒœè¨ºæ–­",
      resultType: topKey,
      resultEmoji: type.icon || "",
      resultDesc: type.catch || "",
      scores: scores,
      maxScore: 25
    });
  }
}

function copyShare() {
  const text = document.getElementById('share-text').textContent;
  navigator.clipboard.writeText(text).then(() => {
    const done = document.getElementById('copy-done');
    done.style.opacity = '1';
    setTimeout(() => done.style.opacity = '0', 2500);
  });
}

function retryQuiz() {
  switchScreen('start');
}

function switchScreen(name) {
  ['start','quiz','loading','result'].forEach(s => {
    const el = document.getElementById(`screen-${s}`);
    el.style.display = 'none';
  });
  const target = document.getElementById(`screen-${name}`);
  target.style.display = 'flex';
  window.scrollTo({top:0, behavior:'smooth'});
}
</script>
</body>
</html>
